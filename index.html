<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOSBox Web Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #00ff00;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid #00ff00;
        }

        .header h1 {
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .dosbox-container {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ff00;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .dosbox-header {
            background: rgba(0, 255, 0, 0.1);
            padding: 10px 20px;
            border-bottom: 1px solid #00ff00;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dosbox-title {
            font-weight: bold;
        }

        .dosbox-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #00ff00;
            cursor: pointer;
        }

        .control-btn.close { background: #ff4444; }
        .control-btn.minimize { background: #ffaa00; }
        .control-btn.maximize { background: #00ff00; }

        #dosbox-canvas {
            width: 100%;
            height: 600px;
            background: #000;
            display: block;
            border: none;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            background: linear-gradient(145deg, #0a4a0a, #064406);
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 10px 20px;
            font-family: inherit;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            background: linear-gradient(145deg, #00ff00, #00cc00);
            color: #000;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(145deg, #4a0a4a, #440644);
            border: 2px solid #ff00ff;
            color: #ff00ff;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .file-label:hover {
            background: linear-gradient(145deg, #ff00ff, #cc00cc);
            color: #000;
            box-shadow: 0 0 15px rgba(255, 0, 255, 0.5);
        }

        .status {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #00ff00;
            max-width: 800px;
            width: 100%;
        }

        .status.error {
            border-left-color: #ff4444;
            color: #ff8888;
        }

        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 0, 0.3);
            max-width: 800px;
            width: 100%;
            margin-top: 20px;
        }

        .info-panel h3 {
            color: #00ffff;
            margin-bottom: 15px;
            text-align: center;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            border-left: 3px solid #00ff00;
        }

        .info-item strong {
            color: #00ffff;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .btn, .file-label {
                text-align: center;
            }
            
            #dosbox-canvas {
                height: 400px;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid rgba(0, 255, 0, 0.3);
            border-top: 3px solid #00ff00;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üñ•Ô∏è DOSBox Web Runner</h1>
        <p>Experience classic DOS games and applications in your browser</p>
    </div>

    <div class="container">
        <div class="dosbox-container">
            <div class="dosbox-header">
                <div class="dosbox-title">DOSBox Emulator</div>
                <div class="dosbox-controls">
                    <div class="control-btn minimize"></div>
                    <div class="control-btn maximize"></div>
                    <div class="control-btn close"></div>
                </div>
            </div>
            <canvas id="dosbox-canvas" width="800" height="600"></canvas>
        </div>

        <div class="controls">
            <button class="btn" id="start-btn" onclick="startDOSBox()">Start DOSBox</button>
            <button class="btn" id="stop-btn" onclick="stopDOSBox()" disabled>Stop DOSBox</button>
            <label for="file-input" class="file-label">Load DOS Program (.exe/.com/.zip)</label>
            <input type="file" id="file-input" class="file-input" accept=".exe,.com,.zip,.bat" onchange="loadFile(event)">
            <button class="btn" onclick="sendCommand('dir')">List Files (DIR)</button>
            <button class="btn" onclick="sendCommand('games')">Show Games</button>
            <button class="btn" onclick="sendCommand('autorun')">Run Game</button>
            <button class="btn" onclick="sendCommand('cls')">Clear Screen (CLS)</button>
        </div>

        <div class="status" id="status">
            Ready to start DOSBox. Click "Start DOSBox" to begin.
        </div>

        <div class="info-panel">
            <h3>Usage Instructions</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Getting Started:</strong><br>
                    Click "Start DOSBox" to initialize the emulator. This will boot into a DOS environment where you can run commands.
                </div>
                <div class="info-item">
                    <strong>Loading Programs:</strong><br>
                    Use the "Load DOS Program" button to upload .exe, .com, .zip, or .bat files to run in DOSBox.
                </div>
                <div class="info-item">
                    <strong>Basic Commands:</strong><br>
                    ‚Ä¢ DIR - List files<br>
                    ‚Ä¢ CLS - Clear screen<br>
                    ‚Ä¢ CD - Change directory<br>
                    ‚Ä¢ TYPE filename - View file contents
                </div>
                <div class="info-item">
                    <strong>Controls:</strong><br>
                    Use your keyboard normally. Most DOS programs will work as expected. Press Alt+Enter for fullscreen (if supported).
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        let dosboxInstance = null;
        let isRunning = false;

        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = isError ? 'status error' : 'status';
        }

        function updateButtons() {
            document.getElementById('start-btn').disabled = isRunning;
            document.getElementById('stop-btn').disabled = !isRunning;
        }

        async function startDOSBox() {
            if (isRunning) return;

            try {
                updateStatus('Loading DOSBox...');
                
                const canvas = document.getElementById('dosbox-canvas');
                canvas.style.display = 'block';
                
                // Clear any previous content
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const scale = window.devicePixelRatio || 1;
                canvas.width = rect.width * scale;
                canvas.height = rect.height * scale;
                ctx.scale(scale, scale);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(0, 0, rect.width, rect.height);
                ctx.fillStyle = '#00ff00';
                ctx.font = '16px "Courier New", monospace';
                ctx.textBaseline = 'top';
                ctx.fillText('Initializing DOSBox...', 10, 30);
                
                // Simple DOS-like simulation for demo
                setTimeout(() => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    const lines = [
                        'DOSBox Web Emulator v1.0',
                        'Copyright (C) 2024 DOSBox Team',
                        '',
                        'Welcome to DOSBox!',
                        'Type HELP for a list of commands.',
                        'You can now type commands directly!',
                        '',
                        'C:\\>'
                    ];
                    
                    lines.forEach(line => {
                        commandHistory.push(line);
                    });
                    
                    redrawScreen();
                    
                    isRunning = true;
                    updateStatus('DOSBox is running! Type commands directly or use the buttons below.');
                    updateButtons();
                    
                    // Make canvas focusable for keyboard input
                    canvas.tabIndex = 0;
                    canvas.focus();
                    
                }, 1500);

            } catch (error) {
                console.error('Error starting DOSBox:', error);
                updateStatus('Error starting DOSBox: ' + error.message, true);
                isRunning = false;
                updateButtons();
            }
        }

        function stopDOSBox() {
            isRunning = false;
            updateStatus('DOSBox stopped.');
            updateButtons();
            
            // Clear canvas properly
            const canvas = document.getElementById('dosbox-canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            ctx.scale(scale, scale);
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, rect.width, rect.height);
            ctx.fillStyle = '#888888';
            ctx.font = '16px "Courier New", monospace';
            ctx.textBaseline = 'top';
            ctx.fillText('DOSBox stopped. Click Start to run again.', 10, rect.height / 2 - 10);
        }

        let currentDirectory = 'C:\\';
        let fileSystem = {
            'AUTOEXEC.BAT': 'echo Welcome to DOSBox!\necho Type HELP for commands',
            'CONFIG.SYS': 'files=30\nbuffers=20',
            'COMMAND.COM': '[DOS Command Interpreter]'
        };
        let commandHistory = [];
        let currentInput = '';
        let cursorVisible = true;
        let gameRunning = false;

        // Cursor blinking
        setInterval(() => {
            cursorVisible = !cursorVisible;
            if (isRunning) {
                redrawScreen();
            }
        }, 500);

        function redrawScreen() {
            const canvas = document.getElementById('dosbox-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas to actual pixel dimensions for crisp text
            const rect = canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            ctx.scale(scale, scale);
            
            // Clear screen with black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            const lineHeight = 18;
            const maxLines = Math.floor((rect.height - 40) / lineHeight); // Leave space for prompt
            let y = 20;
            
            // Show command history (with scrolling if needed)
            const visibleHistory = commandHistory.slice(-maxLines);
            visibleHistory.forEach(line => {
                ctx.fillStyle = '#00ff00';
                ctx.font = '14px "Courier New", monospace';
                ctx.textBaseline = 'top';
                
                // Handle long lines by wrapping
                const maxWidth = rect.width - 20;
                const words = line.split(' ');
                let currentLine = '';
                
                words.forEach(word => {
                    const testLine = currentLine + (currentLine ? ' ' : '') + word;
                    const metrics = ctx.measureText(testLine);
                    
                    if (metrics.width > maxWidth && currentLine) {
                        ctx.fillText(currentLine, 10, y);
                        y += lineHeight;
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                });
                
                if (currentLine) {
                    ctx.fillText(currentLine, 10, y);
                    y += lineHeight;
                }
            });
            
            // Show current prompt and input at bottom
            const promptY = Math.max(y, rect.height - 25);
            const promptText = currentDirectory + '>' + currentInput;
            ctx.fillStyle = '#00ff00';
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText(promptText, 10, promptY);
            
            // Show cursor
            if (cursorVisible && !gameRunning) {
                const textWidth = ctx.measureText(promptText).width;
                ctx.fillText('_', 10 + textWidth, promptY);
            }
        }

        function processCommand(command) {
            // Add command to history
            commandHistory.push(currentDirectory + '>' + command);
            
            const cmd = command.toLowerCase().trim();
            let output = '';
            
            if (!cmd) {
                commandHistory.push('');
                return;
            }
            
            switch(cmd) {
                case 'dir':
                    output = 'Directory of ' + currentDirectory + '\n\n';
                    const files = Object.keys(fileSystem);
                    files.forEach(file => {
                        const size = Math.floor(Math.random() * 50000) + 1000;
                        const date = new Date().toLocaleDateString('en-US', {
                            month: '2-digit',
                            day: '2-digit',
                            year: '2-digit'
                        });
                        const time = new Date().toLocaleTimeString('en-US', {
                            hour12: false,
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        output += `${file.padEnd(12)} ${size.toString().padStart(8)} ${date}  ${time}\n`;
                    });
                    output += `\n       ${files.length} File(s)     ${Math.floor(Math.random() * 1000000)} bytes free`;
                    break;
                    
                case 'cls':
                    commandHistory = [];
                    output = '';
                    break;
                    
                case 'help':
                    output = 'Commands available:\n\n' +
                            'DIR          Lists files and directories\n' +
                            'CLS          Clears the screen\n' +
                            'TYPE <file>  Displays contents of a file\n' +
                            'ECHO <text>  Displays text\n' +
                            'VER          Shows DOS version\n' +
                            'DATE         Shows current date\n' +
                            'TIME         Shows current time\n' +
                            'GAMES        Shows available games\n' +
                            'DOOM2/DOOM   Runs DOOM (if installed)\n' +
                            'HELP         Shows this help message\n\n' +
                            'To play games:\n' +
                            '1. Upload any game ZIP file or EXE file\n' +
                            '2. Type "games" to see available games\n' +
                            '3. Type the game name to run it\n' +
                            '4. Or use "autorun" to run the first game found';
                    break;
                    
                case 'ver':
                    output = 'DOSBox Web Emulator Version 1.0\n' +
                            'Copyright (C) 2024 Web DOS Team\n' +
                            'Built on ' + new Date().toLocaleDateString();
                    break;
                    
                case 'date':
                    output = 'Current date is ' + new Date().toLocaleDateString('en-US', {
                        weekday: 'short',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    break;
                    
                case 'time':
                    output = 'Current time is ' + new Date().toLocaleTimeString('en-US', {
                        hour12: false
                    });
                    break;
                
                case 'doom2':
                case 'doom':
                    if (fileSystem['DOOM2.EXE'] || fileSystem['DOOM.EXE']) {
                        runGame('DOOM', 'DOOM2.EXE');
                    } else {
                        output = 'DOOM2.EXE not found. Please upload a DOOM 2 ZIP file first.';
                    }
                    break;
                    
                case 'games':
                    const gameFiles = Object.keys(fileSystem).filter(file => 
                        file.endsWith('.EXE') && !['COMMAND.COM'].includes(file)
                    );
                    if (gameFiles.length > 0) {
                        output = 'Available games/programs:\n\n';
                        gameFiles.forEach((game, index) => {
                            const gameName = game.replace('.EXE', '');
                            output += `  ${(index + 1).toString().padStart(2)}. ${game.padEnd(15)} - Type: ${gameName.toLowerCase()}\n`;
                        });
                        output += '\nType the filename (without .EXE) to run the game/program.';
                    } else {
                        output = 'No executable files found. Upload a game ZIP or EXE file to play games.';
                    }
                    break;
                    
                case 'autorun':
                    // Automatically run the first game found
                    const firstGame = Object.keys(fileSystem).find(file => 
                        file.endsWith('.EXE') && !['COMMAND.COM'].includes(file)
                    );
                    if (firstGame) {
                        const gameName = firstGame.replace('.EXE', '');
                        processCommand(gameName.toLowerCase());
                        return;
                    } else {
                        output = 'No games found to auto-run.';
                    }
                    break;
                    
                default:
                    if (cmd.startsWith('type ')) {
                        const filename = cmd.substring(5).toUpperCase();
                        if (fileSystem[filename]) {
                            output = fileSystem[filename];
                        } else {
                            output = 'File not found - ' + filename;
                        }
                    } else if (cmd.startsWith('echo ')) {
                        output = cmd.substring(5);
                    } else if (cmd.startsWith('cd ')) {
                        output = 'Directory change not implemented in this demo';
                    } else if (fileSystem[cmd.toUpperCase() + '.EXE']) {
                        const exeName = cmd.toUpperCase() + '.EXE';
                        const gameDisplayName = cmd.toUpperCase();
                        runGame(gameDisplayName, exeName);
                        return;
                    } else if (fileSystem[cmd.toUpperCase() + '.COM']) {
                        const comName = cmd.toUpperCase() + '.COM';
                        const gameDisplayName = cmd.toUpperCase();
                        runGame(gameDisplayName, comName);
                        return;
                    } else {
                        output = "Bad command or file name";
                    }
            }
            
            if (output) {
                output.split('\n').forEach(line => {
                    commandHistory.push(line);
                });
            }
            
            commandHistory.push('');
        }

        function runGame(gameName, executableFile) {
            commandHistory.push('Starting ' + gameName + '...');
            commandHistory.push('');
            
            // Create game-specific startup sequence
            const gameStartup = generateGameStartup(gameName, executableFile);
            gameStartup.forEach(line => {
                commandHistory.push(line);
            });
            
            commandHistory.push('');
            commandHistory.push('>>> PRESS ENTER TO START THE GAME <<<');
            commandHistory.push('(Make sure the DOS screen is clicked/focused)');
            
            gameRunning = true;
            redrawScreen();
            
            // Wait for user input to "start" the game
            currentInput = '';
            
            // Override the normal command processing while game is starting
            const originalProcessCommand = processCommand;
            window.tempProcessCommand = function(command) {
                // Start the actual game simulation regardless of what was typed
                startGameSimulation(gameName, executableFile);
                // Restore normal command processing
                window.processCommand = originalProcessCommand;
                delete window.tempProcessCommand;
            };
            
            updateStatus('Game loaded! Click the DOS screen and press ENTER to start playing.');
        }

        function startGameSimulation(gameName, executableFile) {
            // Clear screen and start game
            commandHistory = [];
            
            // Create game-specific interface
            createGameInterface(gameName);
            
            gameRunning = true;
            redrawScreen();
            
            // Show game controls
            setTimeout(() => {
                showGameControls(gameName);
            }, 1000);
        }

        function createGameInterface(gameName) {
            const canvas = document.getElementById('dosbox-canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            ctx.scale(scale, scale);
            
            // Clear with black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            // Create game-specific visuals
            if (gameName.includes('DOOM') || gameName.includes('QUAKE')) {
                createDoomInterface(ctx, rect.width, rect.height);
            } else if (gameName.includes('PRINCE') || gameName.includes('PERSIA')) {
                createPrinceInterface(ctx, rect.width, rect.height);
            } else if (gameName.includes('SIM') || gameName.includes('CITY')) {
                createSimCityInterface(ctx, rect.width, rect.height);
            } else if (gameName.includes('COMMANDER') || gameName.includes('KEEN')) {
                createKeenInterface(ctx, rect.width, rect.height);
            } else {
                createGenericGameInterface(ctx, rect.width, rect.height, gameName);
            }
        }

        function createDoomInterface(ctx, width, height) {
            // Draw DOOM-style HUD
            ctx.fillStyle = '#8B4513'; // Brown walls
            ctx.fillRect(0, 0, width, height * 0.6);
            
            ctx.fillStyle = '#654321'; // Darker brown
            for (let i = 0; i < 5; i++) {
                ctx.fillRect(i * (width/5), height * 0.1, 20, height * 0.4);
            }
            
            // Floor
            ctx.fillStyle = '#666666';
            ctx.fillRect(0, height * 0.6, width, height * 0.4);
            
            // HUD
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, height * 0.85, width, height * 0.15);
            
            ctx.fillStyle = '#00ff00';
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText('HEALTH: 100%', 10, height * 0.9);
            ctx.fillText('ARMOR: 0%', 150, height * 0.9);
            ctx.fillText('AMMO: 50', 280, height * 0.9);
            
            // Crosshair
            ctx.fillStyle = '#ffffff';
            const centerX = width / 2;
            const centerY = height * 0.35;
            ctx.fillRect(centerX - 10, centerY - 1, 20, 2);
            ctx.fillRect(centerX - 1, centerY - 10, 2, 20);
            
            // Add some "enemies"
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(width * 0.7, height * 0.3, 30, 60);
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px "Courier New", monospace';
            ctx.fillText('IMP', width * 0.7 + 5, height * 0.25);
        }

        function createPrinceInterface(ctx, width, height) {
            // Draw palace walls
            ctx.fillStyle = '#DEB887'; // Tan walls
            ctx.fillRect(0, 0, width, height * 0.7);
            
            // Add palace details
            ctx.fillStyle = '#8B7355';
            for (let i = 0; i < width; i += 40) {
                ctx.fillRect(i, 0, 4, height * 0.7);
            }
            
            // Floor
            ctx.fillStyle = '#CD853F';
            ctx.fillRect(0, height * 0.7, width, height * 0.3);
            
            // Add floor tiles
            ctx.strokeStyle = '#8B7355';
            ctx.lineWidth = 1;
            for (let x = 0; x < width; x += 30) {
                for (let y = height * 0.7; y < height; y += 20) {
                    ctx.strokeRect(x, y, 30, 20);
                }
            }
            
            // Prince character (simple representation)
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(width * 0.1, height * 0.55, 20, 40);
            ctx.fillStyle = '#ffdbac'; // Skin color
            ctx.fillRect(width * 0.1 + 2, height * 0.55, 16, 15);
            
            // Sword
            ctx.fillStyle = '#c0c0c0';
            ctx.fillRect(width * 0.1 + 25, height * 0.6, 15, 3);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText('Lives: 3', 10, 20);
            ctx.fillText('Time: 60:00', width - 100, 20);
        }

        function createSimCityInterface(ctx, width, height) {
            // Create grid-based city view
            ctx.fillStyle = '#228B22'; // Green background
            ctx.fillRect(0, 0, width, height);
            
            // Draw city grid
            ctx.strokeStyle = '#006400';
            ctx.lineWidth = 1;
            const gridSize = 30;
            for (let x = 0; x <= width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y <= height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Add some buildings
            const buildings = [
                {x: 60, y: 60, w: 30, h: 30, color: '#808080'}, // Residential
                {x: 120, y: 90, w: 30, h: 30, color: '#0000ff'}, // Commercial  
                {x: 180, y: 60, w: 30, h: 30, color: '#ffff00'}, // Industrial
            ];
            
            buildings.forEach(building => {
                ctx.fillStyle = building.color;
                ctx.fillRect(building.x, building.y, building.w, building.h);
                ctx.strokeStyle = '#000000';
                ctx.strokeRect(building.x, building.y, building.w, building.h);
            });
            
            // HUD
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, height - 60, width, 60);
            ctx.fillStyle = '#00ff00';
            ctx.font = '12px "Courier New", monospace';
            ctx.fillText('Population: 1,234', 10, height - 40);
            ctx.fillText('Funds: $15,000', 10, height - 20);
            ctx.fillText('Date: Jan 1990', width - 120, height - 40);
        }

        function createKeenInterface(ctx, width, height) {
            // Space/alien theme
            ctx.fillStyle = '#000080'; // Dark blue sky
            ctx.fillRect(0, 0, width, height * 0.7);
            
            // Add stars
            ctx.fillStyle = '#ffffff';
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height * 0.7;
                ctx.fillRect(x, y, 2, 2);
            }
            
            // Alien ground
            ctx.fillStyle = '#ff6347';
            ctx.fillRect(0, height * 0.7, width, height * 0.3);
            
            // Commander Keen
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(width * 0.1, height * 0.6, 15, 25);
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(width * 0.1 + 2, height * 0.6, 11, 8); // Helmet
            
            // Aliens
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(width * 0.6, height * 0.65, 12, 20);
            ctx.fillRect(width * 0.8, height * 0.67, 10, 18);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText('Score: 0', 10, 20);
            ctx.fillText('Lives: 3', width - 80, 20);
        }

        function createGenericGameInterface(ctx, width, height, gameName) {
            // Generic game interface
            ctx.fillStyle = '#000080';
            ctx.fillRect(0, 0, width, height);
            
            // Add some generic game elements
            ctx.fillStyle = '#ffffff';
            ctx.font = '20px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText(gameName, width / 2, height / 2 - 40);
            
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText('GAME IN PROGRESS', width / 2, height / 2);
            
            // Simple game elements
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(width * 0.2, height * 0.7, 20, 20);
            ctx.fillRect(width * 0.5, height * 0.6, 20, 20);
            ctx.fillRect(width * 0.8, height * 0.8, 20, 20);
            
            ctx.textAlign = 'left';
            ctx.fillStyle = '#00ff00';
            ctx.fillText('Score: 0', 10, height - 20);
        }

        function showGameControls(gameName) {
            // Add control instructions to the bottom of the screen
            const canvas = document.getElementById('dosbox-canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            
            // Control bar
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, rect.height - 80, rect.width, 80);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px "Courier New", monospace';
            ctx.fillText('GAME CONTROLS:', 10, rect.height - 60);
            ctx.fillText('ARROW KEYS: Move    SPACE: Action    ENTER: Pause', 10, rect.height - 40);
            ctx.fillText('ESC: Exit Game    Click anywhere to interact', 10, rect.height - 20);
            
            // Set up game interaction
            setupGameInteraction(gameName);
        }

        function setupGameInteraction(gameName) {
            // Add click handler for game interaction
            const canvas = document.getElementById('dosbox-canvas');
            let gameScore = 0;
            let gameTime = 60;
            
            const gameClickHandler = function(e) {
                if (!gameRunning) return;
                
                gameScore += 10;
                
                // Simple click-based game mechanics
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Redraw interface with updated score
                createGameInterface(gameName);
                showGameControls(gameName);
                
                // Update score display
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffff00';
                ctx.font = '14px "Courier New", monospace';
                ctx.fillText(`Score: ${gameScore}`, 10, 30);
                ctx.fillText(`Click to play! Clicks: ${gameScore/10}`, rect.width - 200, 30);
                
                // Add click effect
                ctx.fillStyle = '#ff0000';
                ctx.fillRect(x - 5, y - 5, 10, 10);
            };
            
            canvas.addEventListener('click', gameClickHandler);
            
            // Game timer
            const gameTimer = setInterval(() => {
                if (!gameRunning) {
                    canvas.removeEventListener('click', gameClickHandler);
                    clearInterval(gameTimer);
                    return;
                }
                
                gameTime--;
                if (gameTime <= 0 || Math.random() < 0.1) { // Random chance to end game
                    endGame(gameName, gameScore);
                    canvas.removeEventListener('click', gameClickHandler);
                    clearInterval(gameTimer);
                }
            }, 1000);
        }

        function endGame(gameName, finalScore) {
            gameRunning = false;
            
            // Show game over screen
            const canvas = document.getElementById('dosbox-canvas');
            const ctx = canvas.getContext('2d');
            const rect = canvas.getBoundingClientRect();
            const scale = window.devicePixelRatio || 1;
            
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            ctx.scale(scale, scale);
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, rect.width, rect.height);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = '24px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('GAME OVER', rect.width / 2, rect.height / 2 - 60);
            
            ctx.font = '16px "Courier New", monospace';
            ctx.fillText(`Final Score: ${finalScore}`, rect.width / 2, rect.height / 2 - 20);
            ctx.fillText('Thanks for playing ' + gameName + '!', rect.width / 2, rect.height / 2 + 20);
            
            ctx.font = '14px "Courier New", monospace';
            ctx.fillText('>>> PRESS ENTER TO RETURN TO DOS <<<', rect.width / 2, rect.height / 2 + 60);
            ctx.fillText('(Click the screen first, then press ENTER)', rect.width / 2, rect.height / 2 + 80);
            
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            // Set up exit handler
            window.gameExitHandler = function(e) {
                if (e.key === 'Enter') {
                    commandHistory = ['', '=== RETURNED TO DOS ===', 'Game ended normally. Welcome back!', ''];
                    redrawScreen();
                    updateStatus('Game completed successfully. Ready for next command.');
                    document.removeEventListener('keydown', window.gameExitHandler);
                    delete window.gameExitHandler;
                    
                    // Restore normal command processing
                    window.processCommand = function(command) {
                        processCommand(command);
                    };
                }
            };
            
            document.addEventListener('keydown', window.gameExitHandler);
            updateStatus('Game Over! Click the DOS screen and press ENTER to continue.');
        }

        function generateGameStartup(gameName, executableFile) {
            const startup = [];
            
            // Generic game loading messages
            startup.push('Loading ' + executableFile + '...');
            startup.push('Checking system requirements...');
            
            // Add some random realistic DOS game startup messages
            const loadingMessages = [
                'Initializing graphics system...',
                'Loading sound drivers...',
                'Checking available memory...',
                'Setting up game environment...',
                'Loading game assets...',
                'Initializing input devices...',
                'Configuring display mode...',
                'Loading game data files...',
                'Preparing audio system...',
                'Setting up controls...'
            ];
            
            // Add 3-5 random loading messages
            const numMessages = Math.floor(Math.random() * 3) + 3;
            const selectedMessages = [];
            for (let i = 0; i < numMessages; i++) {
                const randomMsg = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
                if (!selectedMessages.includes(randomMsg)) {
                    selectedMessages.push(randomMsg);
                }
            }
            
            selectedMessages.forEach(msg => startup.push(msg));
            
            // Add game-specific messages based on filename
            if (gameName.includes('DOOM') || gameName.includes('QUAKE')) {
                startup.push('Loading weapon systems...');
                startup.push('Generating level geometry...');
            } else if (gameName.includes('WOLF') || gameName.includes('CASTLE')) {
                startup.push('Loading castle layout...');
                startup.push('Preparing enemy AI...');
            } else if (gameName.includes('PRINCE') || gameName.includes('PERSIA')) {
                startup.push('Loading palace chambers...');
                startup.push('Preparing sword combat system...');
            } else if (gameName.includes('COMMANDER') || gameName.includes('KEEN')) {
                startup.push('Loading alien worlds...');
                startup.push('Preparing pogo stick physics...');
            } else if (gameName.includes('SIM') || gameName.includes('CITY')) {
                startup.push('Loading city simulation engine...');
                startup.push('Preparing economic models...');
            } else {
                startup.push('Loading game world...');
                startup.push('Preparing gameplay systems...');
            }
            
            startup.push('');
            startup.push('üéÆ GAME READY! üéÆ');
            
            return startup;
        }

        function sendCommand(command) {
            if (!isRunning) {
                updateStatus('DOSBox is not running. Please start it first.', true);
                return;
            }

            processCommand(command);
            redrawScreen();
            updateStatus(`Command executed: ${command.toUpperCase()}`);
        }

        async function loadFile(event) {
            if (!isRunning) {
                updateStatus('Please start DOSBox first before loading files.', true);
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            try {
                updateStatus('Loading file: ' + file.name);

                if (file.name.toLowerCase().endsWith('.zip')) {
                    // Handle ZIP files
                    const zip = new JSZip();
                    const contents = await zip.loadAsync(file);
                    
                    let filesExtracted = 0;
                    let gameFiles = [];
                    let dataFiles = [];
                    
                    // Extract all files from ZIP
                    for (const [filename, zipEntry] of Object.entries(contents.files)) {
                        if (!zipEntry.dir) {
                            const fileData = await zipEntry.async('uint8array');
                            const upperFilename = filename.toUpperCase();
                            
                            // Store file in simulated filesystem with better categorization
                            if (upperFilename.endsWith('.EXE')) {
                                fileSystem[upperFilename] = `[Executable - ${fileData.length} bytes]`;
                                gameFiles.push(upperFilename);
                            } else if (upperFilename.endsWith('.COM')) {
                                fileSystem[upperFilename] = `[DOS Program - ${fileData.length} bytes]`;
                                gameFiles.push(upperFilename);
                            } else if (upperFilename.endsWith('.WAD') || upperFilename.endsWith('.PAK') || 
                                      upperFilename.endsWith('.DAT') || upperFilename.endsWith('.RES')) {
                                fileSystem[upperFilename] = `[Game Data - ${fileData.length} bytes]`;
                                dataFiles.push(upperFilename);
                            } else if (upperFilename.endsWith('.CFG') || upperFilename.endsWith('.INI') || 
                                      upperFilename.endsWith('.TXT') || upperFilename.endsWith('.DOC')) {
                                // Try to convert small text files
                                try {
                                    if (fileData.length < 5000) {
                                        const text = new TextDecoder().decode(fileData);
                                        fileSystem[upperFilename] = text;
                                    } else {
                                        fileSystem[upperFilename] = `[Text File - ${fileData.length} bytes]`;
                                    }
                                } catch (e) {
                                    fileSystem[upperFilename] = `[Configuration - ${fileData.length} bytes]`;
                                }
                            } else if (upperFilename.endsWith('.BAT')) {
                                try {
                                    const batContent = new TextDecoder().decode(fileData);
                                    fileSystem[upperFilename] = batContent;
                                } catch (e) {
                                    fileSystem[upperFilename] = `[Batch File - ${fileData.length} bytes]`;
                                }
                            } else {
                                fileSystem[upperFilename] = `[Data File - ${fileData.length} bytes]`;
                            }
                            filesExtracted++;
                        }
                    }
                    
                    let statusMessage = `ZIP extracted: ${filesExtracted} files loaded.`;
                    
                    // Enhanced detection and messaging
                    if (gameFiles.length > 0) {
                        statusMessage += ` Found ${gameFiles.length} executable(s).`;
                        
                        setTimeout(() => {
                            commandHistory.push('');
                            commandHistory.push('=== ZIP FILE EXTRACTED SUCCESSFULLY ===');
                            commandHistory.push(`Total files: ${filesExtracted}`);
                            commandHistory.push(`Executables: ${gameFiles.length}`);
                            commandHistory.push(`Data files: ${dataFiles.length}`);
                            commandHistory.push('');
                            
                            if (gameFiles.length === 1) {
                                const gameName = gameFiles[0].replace('.EXE', '').replace('.COM', '');
                                commandHistory.push(`üéÆ GAME DETECTED: ${gameName}`);
                                commandHistory.push(`Type "${gameName.toLowerCase()}" to play!`);
                                commandHistory.push(`Or type "autorun" to start automatically.`);
                            } else {
                                commandHistory.push('üéÆ MULTIPLE GAMES/PROGRAMS FOUND:');
                                gameFiles.forEach(game => {
                                    const gameName = game.replace('.EXE', '').replace('.COM', '');
                                    commandHistory.push(`  - Type "${gameName.toLowerCase()}" to run ${game}`);
                                });
                            }
                            
                            commandHistory.push('');
                            commandHistory.push('Type "games" to see all available programs');
                            commandHistory.push('Type "dir" to see all files');
                            commandHistory.push('');
                            redrawScreen();
                        }, 1000);
                    } else {
                        statusMessage += ' No executables found.';
                    }
                    
                    updateStatus(statusMessage);
                    
                } else {
                    // Handle single EXE/COM files
                    const arrayBuffer = await file.arrayBuffer();
                    const upperFilename = file.name.toUpperCase();
                    
                    if (upperFilename.endsWith('.EXE') || upperFilename.endsWith('.COM')) {
                        fileSystem[upperFilename] = `[Game Executable - ${arrayBuffer.byteLength} bytes]`;
                        const gameName = upperFilename.replace('.EXE', '').replace('.COM', '');
                        
                        updateStatus(`Game loaded: ${file.name}. Type "${gameName.toLowerCase()}" to run it!`);
                        
                        // Show helpful message
                        setTimeout(() => {
                            commandHistory.push('');
                            commandHistory.push('=== GAME FILE LOADED ===');
                            commandHistory.push(`File: ${upperFilename}`);
                            commandHistory.push(`üéÆ Type "${gameName.toLowerCase()}" to play!`);
                            commandHistory.push('Or use the "Run Game" button below');
                            commandHistory.push('');
                            redrawScreen();
                        }, 500);
                    } else {
                        fileSystem[upperFilename] = `[Data File - ${arrayBuffer.byteLength} bytes]`;
                        updateStatus(`File loaded: ${file.name}. Use DIR command to see it listed.`);
                    }
                }
                
                // Show updated directory
                setTimeout(() => {
                    sendCommand('dir');
                }, 500);

            } catch (error) {
                console.error('Error loading file:', error);
                updateStatus('Error loading file: ' + error.message, true);
            }

            // Reset file input
            event.target.value = '';
        }

        // Initialize
        updateButtons();
        updateStatus('Ready to start DOSBox simulation. Click "Start DOSBox" to begin.');

        // Add keyboard input support
        document.addEventListener('keydown', function(e) {
            // Only handle input when DOSBox is running and canvas is focused
            if (!isRunning) return;
            
            const canvas = document.getElementById('dosbox-canvas');
            if (document.activeElement !== canvas) return;
            
            // Special handling when game is waiting to start
            if (gameRunning && window.tempProcessCommand) {
                if (e.key === 'Enter') {
                    window.tempProcessCommand('');
                    e.preventDefault();
                    return;
                }
            }
            
            switch(e.key) {
                case 'Enter':
                    if (currentInput.trim()) {
                        processCommand(currentInput);
                        currentInput = '';
                        redrawScreen();
                        updateStatus('Command executed. Type another command or use the buttons.');
                    }
                    break;
                    
                case 'Backspace':
                    if (currentInput.length > 0) {
                        currentInput = currentInput.slice(0, -1);
                        redrawScreen();
                    }
                    break;
                    
                case 'Escape':
                    // Exit game if running
                    if (gameRunning) {
                        endGameEarly();
                    }
                    break;
                    
                case 'Tab':
                case 'ArrowUp':
                case 'ArrowDown':
                case 'ArrowLeft':
                case 'ArrowRight':
                    // Prevent default behavior for these keys
                    break;
                    
                default:
                    // Add regular characters to input (only if not in game mode)
                    if (e.key.length === 1 && !gameRunning) {
                        // Convert to uppercase for DOS-like behavior
                        currentInput += e.key.toUpperCase();
                        redrawScreen();
                    }
                    break;
            }
            
            e.preventDefault();
        });

        function endGameEarly() {
            gameRunning = false;
            commandHistory = ['', '=== GAME INTERRUPTED ===', 'Returned to DOS prompt.', ''];
            redrawScreen();
            updateStatus('Game exited. Back to DOS prompt.');
            
            // Restore normal command processing
            if (window.tempProcessCommand) {
                window.processCommand = function(command) {
                    processCommand(command);
                };
                delete window.tempProcessCommand;
            }
        }

        // Handle canvas clicks to focus and show instructions
        document.getElementById('dosbox-canvas').addEventListener('click', function() {
            this.focus();
            if (isRunning) {
                updateStatus('Canvas focused. You can now type DOS commands directly!');
            }
        });

        // Add some sample commands to try
        function addSampleCommand(command, description) {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = command.toUpperCase();
            btn.onclick = () => sendCommand(command);
            btn.title = description;
            return btn;
        }
    </script>
</body>
</html>
